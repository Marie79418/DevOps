# define job to build and publish docker image
build-and-push-docker-image:
 needs: test-backend
 # run only when code is compiling and tests are passing
 runs-on: ubuntu-24.04

 # steps to perform in job
 steps:
   - name: Checkout code
     uses: actions/checkout@v4


   - name: Login to DockerHub
     run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin


   - name: Build image and push backend
     uses: docker/build-push-action@v6
     with:
       # relative path to the place where source code with Dockerfile is located
       context: ./simple-api      # pas s√ªre de moi
       # Note: tags has to be all lower-case
       tags:  ${{secrets.DOCKERHUB_USERNAME}}/springboot-api:latest
       # build on feature branches, push only on main branch
       push: ${{ github.ref == 'refs/heads/main' }}

   - name: Build image and push database
       # DO the same for database
      uses: docker/build-push-action@v6
      with:
        # relative path to the place where source code with Dockerfile is located
        context: ./database
        # Note: tags has to be all lower-case
        tags:  ${{secrets.DOCKERHUB_USERNAME}}/mcatillon/postgres_custom:latest
        # build on feature branches, push only on main branch
        push: ${{ github.ref == 'refs/heads/main' }}

   - name: Build image and push httpd
     # DO the same for httpd
      uses: docker/build-push-action@v6
      with:
        # relative path to the place where source code with Dockerfile is located
        context: ./http-server
        # Note: tags has to be all lower-case
        tags:  ${{secrets.DOCKERHUB_USERNAME}}/my-http-server:latest
        # build on feature branches, push only on main branch
        push: ${{ github.ref == 'refs/heads/main' }}

  
